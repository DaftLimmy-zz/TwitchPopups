<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="jquery-3.4.1.min.js"></script>
    <script src="tmi.min.js"></script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Open Sans Condensed:700">

	<style>
		#popuptext {
		    display: inline-block;
			font-family: 'Open Sans Condensed';
			font-weight: 700;
			color: white;
			font-size: 60px;
			margin: 0;
			margin-left: 15px;
			white-space: nowrap;
			position: relative; /* To allow marquee scrolling */
		}

		#popupbox {
			position: absolute;
			bottom: 20px;
            left: 20px;
			width: 0px;
			height: 82px;
			overflow: hidden;
			background-color: #00AA00;
		}
		
	</style>

</head>

<body>

	<div id="popupbox">
	    <h1 id="popuptext">&nbsp;</h1>
		<!--Added &nbsp; as a hack as first run after refresh popuptext.width was incorrect, this for whatever reason fixes it -->
	</div>

</body>
    
<script type="text/javascript">

    // Define configuration options
    const opts = {
        channels: [
          "Limmy"
        ]
    };

    // Create a client with our options
    let client = new tmi.client(opts);

    // Register our event handlers (defined below)
    client.on('message', onMessageHandler);
    client.on('connected', onConnectedHandler);

    // Connect to Twitch:
    client.connect();

    //
    //
    // =========
    // ANIMATION
    // =========    
    

    // Hotseat stuff
    var hotseatuser = "";
    var hotseatison = false;
    //
	
    // Marquee stuff
    var textWidth = 0;
    var leftMovement = 0;
    var stopped = true;
    var animateWidth = 0;
    
    // Called every time a message comes in
    function onMessageHandler(target, context, msg, self) {
        // Remove whitespace from chat message
        const commandName = msg.trim();
        
        // If the command is known, let's execute it

            if (context.mod || (context["badges-raw"] != null && context["badges-raw"].startsWith("broadcaster"))) {
                if (commandName.startsWith("!alert ")) {
                    $("#popupbox").show();
                    $("#popupbox").css({"background-color":"#00AA00"}); 
                    $("#popuptext").text(commandName.substr(7).toUpperCase());
                    doAnimation();
                } else if (commandName.startsWith("!delete")) {
                  deleteAnimation();
                } else if (commandName.startsWith("!hotseat ")) {
                  hotseatison = true;
                  $("#popupbox").show();
                  hotseatuser = commandName.substr(10).toLowerCase();
                  $("#popupbox").css({"background-color":"#aa1100"}); 
                  $("#popuptext").text("ðŸ”¥ " + hotseatuser.toUpperCase() + " IS IN THE HOTSEAT ðŸ”¥");
                  doAnimation();
                }
            }
                
            if (hotseatison) {
                if (context.username == hotseatuser){
                    $("#popuptext").text("ðŸ”¥ " + context['display-name'] + ": " + commandName + " ðŸ”¥");
                    doAnimation();
                }
            }
                
    }
        
    // Animate text
    function doAnimation() {
        $('#popuptext').stopMarquee(); //stop marquee if new alert
	textWidth = $("#popuptext").width();
	animateWidth = Math.min(textWidth+30, 1880); //get smallest width between screen width and text width
	if(textWidth > animateWidth) { // if text width is > screen width marquee the text
		stopped = false;
		$('#popuptext').marquee();
	}
	else // if text width is < screen width keep text static
	{
		stopped = true;
	}
        $("#popuptext").css({"opacity":0, "margin-left":"50px"}); 
        $("#popupbox").width(1);
        $("#popupbox").animate({width:animateWidth}, 500);
        $("#popuptext").animate({"opacity":1, "margin-left":"15px"}, 700);
	leftMovement = 0;
    }
    
    function doHotseatAnimation() {
	$('#popuptext').stopMarquee(); //stop marquee if new alert
        textWidth = $("#popuptext").width();
		animateWidth = Math.min(textWidth+30, 1880); //get smallest width between screen width and text width
		if(textWidth > animateWidth) { // if text width is > screen width marquee the text
			stopped = false;
			$('#popuptext').marquee();
		}
		else // if text width is < screen width keep text static
		{
			stopped = true;
		}
        $("#popuptext").css({"opacity":0, "margin-left":"50px"}); 
        $("#popupbox").css({"background-color":"#aa1100"}); 
        $("#popupbox").width(1);
        $("#popupbox").animate({width:animateWidth}, 500);
        $("#popuptext").animate({"opacity":1, "margin-left":"15px"}, 700);
		leftMovement = 0;
    }
    
    
        
    // Animate off
    function deleteAnimation() {
        hotseatison = false;
        $("#popupbox").animate({width:0}, 500);
        $("#popuptext").animate({"opacity":0, "margin-left":"50px"}, 700);
    }
    

    function onConnectedHandler(addr, port) {
        console.log(`* Connected to ${addr}:${port}`);
    }
	
    

    // Marquee function
    (function($) {
    	$.fn.marquee = function() {
		var started = false;
		function go() {
			if(!started) { //if first run or end of run, delay movement for 5 secs
				setTimeout(function() {
					leftMovement = 0;
					started = true;
					if(!stopped) go();
					}, 5000);					
			}
			else { //if marquee is running
				setTimeout(function() {
					leftMovement = leftMovement + 1; //add 1 to left movement value
					if(leftMovement > textWidth - animateWidth + 30) { //if end of text is visible wait 2 seconds and reset
						setTimeout(function() {
							leftMovement = 0;
							started = false;								
						}, 2000);
						
					}
					else // if end of text is not visible, keep scrolling
					{
						$("#popuptext").css({"left": "-" + leftMovement + "px"});
					}
					if(!stopped) go();
				}, 5); // scroll 1 px every 5 ms
			}
		}
		if(!stopped) go();
	}
	$.fn.stopMarquee = function() {
		function go() {
			leftMovement = 0;
			$("#popuptext").css({"left": "0px"});
		}
	}
})(jQuery)

</script>
</html>
