<!DOCTYPE HTML>
<html>
<head>

    <script type="text/javascript">

        // Change Limmy to your Twitch channel
        const twitchChannel = 'Limmy';

        // Your alert background. Default is a vibrant green
        const alertBg = '#00AA00';

        // Hotseat background colour. Default is a fiery, fiery orange.
        const hotseatBg = '#aa1100';

        // The emoji that surrounds the hotseat messages.
        const hotseatEmoji = '🔥';

        // Voting background colour. Default is Twitch purple.
        const votingBg = '#6441a5';

        // The number of options if no options are provided when voting begins. The default is 3.
        const defaultOptionCount = 3;

        // Follow the instructions in README.md
        
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="jquery-3.4.1.min.js"></script>
    <script src="tmi.min.js"></script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Open Sans Condensed:700">

	<style>
		#popuptext {
		    display: inline-block;
			font-family: 'Open Sans Condensed';
			font-weight: 700;
			color: white;
			font-size: 60px;
			margin: 0;
			margin-left: 15px;
			white-space: nowrap;
		}

		#popupbox {
			position: absolute;
			bottom: 20px;
            left: 20px;
			width: 0px;
			height: 82px;
			overflow: hidden;
		}
		
	</style>

</head>

<body>

	<div id="popupbox">
	    <h1 id="popuptext"></h1>		
	</div>

</body>
    
<script type="text/javascript">
    const opts = {
        channels: [
            twitchChannel
        ]
    };

    // Create a client with our options defined at the top of the file
    let client = new tmi.client(opts);

    // Register our event handlers (defined below)
    client.on('message', onMessageHandler);
    client.on('connected', onConnectedHandler);

    // Connect to Twitch:
    client.connect();

    //
    //
    // =========
    // ANIMATION
    // =========    
    

    // Hotseat stuff
    let hotSeatUser = "";
    let hotSeatIsOn = false;
    //
    
    // Voting stuff
    // Voting is pretty generic, mods can set the topic and options and users can vote with option numbers in chat.
    let votingIsOn = false;
    let voteTopic = "";
    let options = {};
    let voters = {};
    //

    // Called every time a message comes in
    function onMessageHandler(target, context, msg, self) {
        // Remove whitespace from chat message
        const commandName = msg.trim();
        
        // If the command is known, let's execute it

            if (context.mod || (context["badges-raw"] != null && context["badges-raw"].startsWith("broadcaster"))) {
                if (commandName.startsWith("!alert ")) {
                    $("#popupbox").show();
                    $("#popupbox").css({"background-color":alertBg}); 
                    $("#popuptext").text(commandName.substr(7).toUpperCase());
                    doAnimation();
                } else if (commandName.startsWith("!delete")) {
                    deleteAnimation();
                } else if (commandName.startsWith("!hotseat ")) {
                    hotSeatIsOn = true;
                    $("#popupbox").show();
                    voteTopic = commandName.substr(10);
                    $("#popupbox").css({"background-color":hotseatBg}); 
                    $("#popuptext").text(`${hotseatEmoji}  ${hotSeatUser.toUpperCase()}`);
                    doAnimation();
                } else if (commandName.startsWith("!vote topic ")) {
                    // Start with the topic for your vote
                    $("#popupbox").show();
                    voteTopic = commandName.substr(6).toUpperCase();
                    $("#popupbox").css({"background-color": votingBg});
                    $("#popuptext").text(`VOTE: ${voteTopic} 🔴`);
                    doAnimation();
                } else if (commandName.startsWith("!vote option ")) {
                    // Then add your options
                    let option = commandName.substr(13).toUpperCase();
                    // Initialise each option with 0 votes
                    options[option] = 0;
                } else if (commandName.startsWith("!vote clear")) {
                    // Made a mistake? clear and re-add your options
                    options = {};
                    voters = {};
                } else if (commandName.startsWith("!vote start") && !votingIsOn) {

                    // If no options were added, add the default options
                    if (Object.entries(options).length === 0) {
                        let optionCount = defaultOptionCount;
                        // If we passed in a number at the end, override the option count
                        if (commandName.length > 11 && /^\d+$/.test(commandName.substr(11))) {
                            optionCount = parseInt(commandName.substr(11));
                        }

                        // Create the options
                        for (let i = 0; i < optionCount; i++) {
                            // Then add your options
                            let option = `OPTION ${i+1}`;
                            // Initialise each option with 0 votes
                            options[option] = 0;
                        }
                    }

                    // Once options are added, start the vote!
                    votingIsOn = true;
                    $("#popuptext").text(`VOTE: ${voteTopic} 🟢`);
                } else if (commandName.startsWith("!vote results") && votingIsOn) {
                    // Display the results and stop the vote
                    const winner = Object.entries(options).sort((a, b) => b[1] - a[1])[0][0];
                    $("#popuptext").text(`AND THE WINNER IS: ${winner} 👏👏👏`);
                    doAnimation();
                }
            }

            if (hotSeatIsOn) {
                if (context.username == hotSeatUser){
                    $("#popuptext").text(`${hotseatEmoji} ${context['display-name']}: ${commandName} ${hotseatEmoji}`);
                    doHotseatAnimation();
                }
            }
                
            // If voting is on and the user typed somthing that can be understood as a vote
            if (votingIsOn && /^\d+$/.test(commandName)) {
                const vote = parseInt(commandName);
                const optionsAsArray = Object.keys(options);
                
                // Ignore invalid votes
                if(vote > optionsAsArray.length) return;

                const voteAsIndex = vote - 1;
                const hasVoted = !!(voters[context.username] || voters[context.username] === 0);

                // If the user has voted before, remove their previous vote
                if(hasVoted) {
                    options[optionsAsArray[voters[context.username]]] -= 1;
                }

                // Record user's vote and add a vote to the option
                voters[context.username] = voteAsIndex;
                options[optionsAsArray[voteAsIndex]] += 1;
            }
    }
        
    // Animate text
    const doAnimation = () => {
        const textWidth = $("#popuptext").width();
        $("#popuptext").css({"opacity":0, "margin-left":"50px"}); 
        $("#popupbox").width(1);
        $("#popupbox").animate({width:textWidth+30}, 500);
        $("#popuptext").animate({"opacity":1, "margin-left":"15px"}, 700);
    }
    
    const doHotseatAnimation = () => {
        const textWidth = $("#popuptext").width();
        $("#popuptext").css({"opacity":0, "margin-left":"50px"}); 
        $("#popupbox").css({"background-color":hotseatBg}); 
        $("#popupbox").width(1);
        $("#popupbox").animate({width:textWidth+30}, 500);
        $("#popuptext").animate({"opacity":1, "margin-left":"15px"}, 700);
    }
    
    
        
    // Animate off
    const deleteAnimation = () => {
        hotSeatIsOn = false;
        votingIsOn = false;
        options = {};
        voters = {};
        $("#popupbox").animate({width:0}, 500);
        $("#popuptext").animate({"opacity":0, "margin-left":"50px"}, 700);
    }
    

    function onConnectedHandler (addr, port) {
        console.log(`* Connected to ${addr}:${port}`);
    }
</script>
</html>